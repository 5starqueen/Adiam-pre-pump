<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Early Pump Alert System</title>
    <style>
        /* (Previous CSS styles remain the same) */
        
        /* Add these new styles */
        .alert-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            max-width: 300px;
            animation: slideIn 0.5s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .alert-close {
            float: right;
            cursor: pointer;
            font-weight: bold;
        }
        
        .alert-content {
            margin-top: 5px;
        }
        
        .alert-symbol {
            font-weight: bold;
            font-size: 18px;
        }
        
        .settings-panel {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .settings-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #f0b90b;
        }
        
        .settings-group {
            margin-bottom: 15px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .checkbox-label input {
            margin-right: 10px;
        }
        
        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- (Previous HTML remains the same until the controls div) -->
    
    <div class="settings-panel">
        <div class="settings-title">Alert Settings</div>
        <div class="settings-group">
            <div class="checkbox-label">
                <input type="checkbox" id="enableAlerts" checked>
                <label for="enableAlerts">Enable Audio Alerts</label>
            </div>
            <div class="checkbox-label">
                <input type="checkbox" id="enableDesktopNotif" checked>
                <label for="enableDesktopNotif">Enable Desktop Notifications</label>
            </div>
        </div>
        <div class="settings-group">
            <div>Alert Threshold:</div>
            <div class="sound-toggle">
                <input type="range" id="alertThreshold" min="5" max="30" value="10" step="5">
                <span id="thresholdValue">10%+</span>
            </div>
        </div>
    </div>
    
    <!-- Alert Banner (hidden by default) -->
    <div id="alertBanner" class="alert-banner">
        <span class="alert-close" onclick="closeAlert()">Ã—</span>
        <div class="alert-symbol" id="alertSymbol"></div>
        <div class="alert-content" id="alertContent"></div>
    </div>
    
    <!-- (Rest of previous HTML remains the same) -->

    <script>
        // Configuration with improved early detection parameters
        const config = {
            binanceAPI: 'https://api.binance.com/api/v3',
            pumpThresholds: {
                potential5: 0.05,
                potential10: 0.10,
                potential20: 0.20,
                potential30: 0.30
            },
            earlyDetectionParams: {
                volumeSpikeThreshold: 2.5,    // 2.5x normal volume
                orderBookImbalance: 1.8,      // Buy/sell ratio threshold
                priceAcceleration: 0.03,      // 3% price acceleration
                minBaseVolume: 50             // 50 BTC minimum volume
            },
            defaultLookback: 24, // hours
            itemsPerPage: 10,
            alertCheckInterval: 30000 // Check for alerts every 30 seconds
        };

        // New state variables
        let alertCheckInterval = null;
        let previousSignals = [];
        let audioContext;
        let alertSound;
        let lastAlertTime = 0;
        
        // Initialize with audio context setup
        document.addEventListener('DOMContentLoaded', async () => {
            // (Previous initialization code remains)
            
            // Setup audio context for alerts
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await setupAlertSound();
            } catch (e) {
                console.error("Audio setup failed:", e);
                document.getElementById('enableAlerts').checked = false;
            }
            
            // Start alert checking
            startAlertChecking();
        });

        // New function for early pump detection
        async function detectEarlyPumpSignals(symbol, tickerData, timeframe) {
            try {
                // 1. Check for volume spike
                const klines = await fetchKlines(symbol, timeframe, config.defaultLookback);
                if (!klines || klines.length < 24) return null;
                
                // Calculate average volume
                const volumes = klines.map(k => parseFloat(k[5]));
                const recentVolume = volumes.slice(-4).reduce((a, b) => a + b, 0) / 4;
                const historicalVolume = volumes.slice(0, -4).reduce((a, b) => a + b, 0) / (volumes.length - 4);
                
                // Skip if no volume spike
                if (recentVolume < historicalVolume * config.earlyDetectionParams.volumeSpikeThreshold) {
                    return null;
                }
                
                // 2. Check order book imbalance (simplified)
                const depth = await fetchDepth(symbol);
                const bidsTotal = depth.bids.reduce((sum, bid) => sum + parseFloat(bid[1]), 0);
                const asksTotal = depth.asks.reduce((sum, ask) => sum + parseFloat(ask[1]), 0);
                const imbalanceRatio = bidsTotal / asksTotal;
                
                if (imbalanceRatio < config.earlyDetectionParams.orderBookImbalance) {
                    return null;
                }
                
                // 3. Check price acceleration
                const closes = klines.map(k => parseFloat(k[4]));
                const latestClose = closes[closes.length - 1];
                const prevClose1 = closes[closes.length - 2];
                const prevClose2 = closes[closes.length - 3];
                
                const recentChange = (latestClose - prevClose1) / prevClose1;
                const previousChange = (prevClose1 - prevClose2) / prevClose2;
                const acceleration = recentChange - previousChange;
                
                if (acceleration < config.earlyDetectionParams.priceAcceleration) {
                    return null;
                }
                
                // If all conditions met, calculate pump potential
                const pumpPotential = recentChange * (1 + acceleration) * imbalanceRatio;
                
                return {
                    symbol: symbol,
                    potential: pumpPotential,
                    currentPrice: latestClose,
                    volume: recentVolume,
                    time: new Date().toLocaleString()
                };
                
            } catch (error) {
                console.error("Early detection error for", symbol, error);
                return null;
            }
        }

        // New function to fetch order book depth
        async function fetchDepth(symbol, limit = 20) {
            const response = await fetch(`${config.binanceAPI}/depth?symbol=${symbol}&limit=${limit}`);
            return await response.json();
        }

        // New function to check for alerts periodically
        function startAlertChecking() {
            alertCheckInterval = setInterval(async () => {
                if (!document.getElementById('enableAlerts').checked) return;
                
                try {
                    const threshold = parseInt(document.getElementById('alertThreshold').value) / 100;
                    const tickerData = await fetch24hrTickerData();
                    const usdtSymbols = usdtPairs.slice(0, 50); // Check top 50 for performance
                    
                    for (const symbol of usdtSymbols) {
                        const signal = await detectEarlyPumpSignals(symbol, tickerData, '15m');
                        if (signal && signal.potential >= threshold) {
                            // Check if this is a new signal
                            const existingSignal = previousSignals.find(s => s.symbol === symbol);
                            const now = Date.now();
                            
                            if (!existingSignal || (now - existingSignal.time > 3600000)) {
                                triggerAlert(signal);
                                previousSignals = previousSignals.filter(s => s.symbol !== symbol);
                                previousSignals.push({...signal, time: now});
                            }
                        }
                    }
                } catch (error) {
                    console.error("Alert check error:", error);
                }
            }, config.alertCheckInterval);
        }

        // New function to trigger alerts
        function triggerAlert(signal) {
            // Skip if alert was very recent
            if (Date.now() - lastAlertTime < 60000) return;
            lastAlertTime = Date.now();
            
            const potentialPercent = (signal.potential * 100).toFixed(1);
            const message = `Potential ${potentialPercent}% pump detected at ${signal.currentPrice}`;
            
            // Update alert banner
            document.getElementById('alertSymbol').textContent = signal.symbol;
            document.getElementById('alertContent').textContent = message;
            document.getElementById('alertBanner').style.display = 'block';
            
            // Play alert sound if enabled
            if (document.getElementById('enableAlerts').checked && alertSound) {
                alertSound.start();
            }
            
            // Show desktop notification if enabled
            if (document.getElementById('enableDesktopNotif').checked && Notification.permission === 'granted') {
                new Notification(`Pump Alert: ${signal.symbol}`, {
                    body: message,
                    icon: 'https://bin.bnbstatic.com/static/images/common/favicon.ico'
                });
            } else if (document.getElementById('enableDesktopNotif').checked && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                document.getElementById('alertBanner').style.display = 'none';
            }, 15000);
        }

        // New function to close alert manually
        function closeAlert() {
            document.getElementById('alertBanner').style.display = 'none';
        }

        // New function to setup alert sound
        async function setupAlertSound() {
            // Create a simple beep sound
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.value = 880;
            gainNode.gain.value = 0.5;
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
            
            // Store for reuse
            alertSound = oscillator;
        }

        // (Previous helper functions remain the same)
    </script>
</body>
</html>
